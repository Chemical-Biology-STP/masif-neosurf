{% extends "base.html" %}

{% block title %}Job Details - {{ metadata.job_name }}{% endblock %}

{% block extra_css %}
<style>
.download-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(4px);
}

.download-modal.active {
    display: flex;
}

.download-modal-content {
    background: white;
    border-radius: 16px;
    padding: 3rem 2.5rem;
    max-width: 480px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.download-modal-spinner {
    width: 64px;
    height: 64px;
    margin: 0 auto 1.5rem;
    border: 4px solid var(--gray-200);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.download-modal h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 0.75rem;
}

.download-modal p {
    color: var(--gray-600);
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-bottom: 0.5rem;
}

.download-modal .warning {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    background: #FEF3C7;
    color: #92400E;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-top: 1.5rem;
    font-size: 0.875rem;
    font-weight: 600;
}

.download-modal .warning svg {
    flex-shrink: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Job Details: {{ metadata.job_name }}</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
        <div>
            <strong>Job ID:</strong><br>
            <code>{{ metadata.job_id }}</code>
        </div>
        <div>
            <strong>Status:</strong><br>
            {% if status in ['RUNNING', 'PENDING', 'CONFIGURING'] %}
                <span class="status-badge status-running">{{ status }}</span>
            {% elif status in ['COMPLETED'] %}
                <span class="status-badge status-completed">{{ status }}</span>
            {% elif status in ['FAILED', 'CANCELLED', 'TIMEOUT', 'NODE_FAIL'] %}
                <span class="status-badge status-failed">{{ status }}</span>
            {% else %}
                <span class="status-badge status-pending">{{ status }}</span>
            {% endif %}
        </div>
        <div>
            <strong>Submitted:</strong><br>
            {{ metadata.submitted_at[:19] }}
        </div>
    </div>
    
    <div style="margin: 1.5rem 0;">
        <strong>Input Files:</strong>
        <ul style="margin-left: 2rem; margin-top: 0.5rem;">
            <li>PDB: {{ metadata.pdb_file }}</li>
            <li>Chain ID: <code>{{ metadata.chain_id }}</code></li>
            {% if metadata.ligand_id %}
            <li>Ligand ID: <code>{{ metadata.ligand_id }}</code></li>
            <li>SDF: {{ metadata.sdf_file }}</li>
            {% endif %}
        </ul>
    </div>
    
    {% if current_user.is_admin %}
    <div style="margin: 1.5rem 0;">
        <strong>Command (Admin Only):</strong>
        <pre>{{ metadata.command }}</pre>
    </div>
    {% endif %}
    
    <div style="margin-top: 1rem;">
        <a href="{{ url_for('list_jobs') }}" class="btn btn-secondary">‚Üê Back to Jobs</a>
        <button onclick="location.reload()" class="btn">Refresh Status</button>
        {% if current_user.is_admin %}
        <button onclick="window.open('{{ url_for('debug_files', job_uuid=job_uuid) }}', '_blank')" class="btn">Debug Files</button>
        {% endif %}
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;">Output Files</h3>
        {% if output_files %}
        <div style="display: flex; gap: 0.5rem;">
            {% if status == 'COMPLETED' %}
            <button onclick="launchPyMOL()" class="btn" id="pymol-launch-btn">
                üî¨ Visualize in PyMOL
            </button>
            {% endif %}
            <button onclick="downloadAllFiles()" class="btn">
                üì¶ Download All (ZIP)
            </button>
        </div>
        {% endif %}
    </div>
    {% if output_files %}
    <div id="file-browser" style="font-family: monospace;">
        <!-- Files will be rendered here by JavaScript -->
    </div>
    {% else %}
    <p style="color: #666; font-style: italic;">
        {% if status in ['RUNNING', 'PENDING', 'CONFIGURING'] %}
        Job is still running. Output files will appear here when the job completes.
        {% elif status in ['COMPLETED'] %}
        No output files found. The job may have completed without generating output files, or there may be an issue accessing the files.
        {% elif status in ['FAILED', 'CANCELLED', 'TIMEOUT', 'NODE_FAIL'] %}
        Job did not complete successfully. No output files available.
        {% else %}
        No output files available yet.
        {% endif %}
    </p>
    {% endif %}
</div>

<style>
.file-tree {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.file-tree li {
    padding: 4px 0;
}

.file-tree .folder {
    cursor: pointer;
    user-select: none;
    padding: 4px 8px;
    border-radius: 4px;
}

.file-tree .folder:hover {
    background-color: #f0f0f0;
}

.file-tree .folder-icon {
    display: inline-block;
    width: 20px;
    transition: transform 0.2s;
}

.file-tree .folder-icon.expanded {
    transform: rotate(90deg);
}

.file-tree .nested {
    display: none;
    padding-left: 24px;
}

.file-tree .nested.active {
    display: block;
}

.file-tree .file-item {
    padding: 4px 8px 4px 28px;
    border-radius: 4px;
}

.file-tree .file-item:hover {
    background-color: #f0f0f0;
}

.file-tree .file-item a {
    text-decoration: none;
    color: #0066cc;
}

.file-tree .file-item a:hover {
    text-decoration: underline;
}
</style>

{% if output_files and status == 'COMPLETED' %}
<div class="card" id="pymol-viewer-card" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;">3D Visualization - PyMOL</h3>
        <button onclick="closePyMOL()" class="btn btn-secondary">
            ‚úï Close Viewer
        </button>
    </div>
    
    <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <p style="margin: 0; font-size: 0.875rem; color: var(--gray-700);">
            <strong>Session ID:</strong> <code id="pymol-session-id" style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px;"></code>
            <span style="margin-left: 1rem;">
                <strong>Expires in:</strong> <span id="pymol-expires"></span>
            </span>
        </p>
    </div>
    
    <div style="position: relative; width: 100%; height: 800px; border: 2px solid var(--gray-300); border-radius: 8px; overflow: hidden; background: var(--gray-900);">
        <iframe 
            id="pymol-iframe" 
            src="" 
            style="width: 100%; height: 100%; border: none;"
            allow="clipboard-read; clipboard-write">
        </iframe>
    </div>
    
    <div style="margin-top: 1rem; padding: 1rem; background: #DBEAFE; border-left: 4px solid #3B82F6; border-radius: 8px; font-size: 0.875rem;">
        <strong>üìã How to Load Your Results in PyMOL:</strong>
        
        <div style="margin: 1rem 0; padding: 1.25rem; background: white; border-radius: 8px; border: 2px solid #3B82F6;">
            <div style="font-weight: 600; margin-bottom: 1rem; color: var(--gray-800); font-size: 1rem;">
                Type this command in the PyMOL console:
            </div>
            
            <div style="background: #F3F4F6; padding: 1rem; margin: 1rem 0; border-radius: 6px; border: 2px dashed #3B82F6;">
                <div style="font-family: 'Courier New', monospace; color: #059669; font-size: 1.1rem; font-weight: 700; text-align: center;">
                    @/data/<span id="pymol-script-path"></span>/load_results.pml
                </div>
            </div>
            
            <div style="background: #FEF3C7; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #92400E;">
                    üí° Pro Tip: Use Tab Autocomplete
                </div>
                <ol style="margin: 0.5rem 0 0 1.5rem; padding: 0; color: var(--gray-700); line-height: 1.8;">
                    <li>Type: <code style="background: white; padding: 0.2rem 0.5rem; border-radius: 3px; color: #059669; font-weight: 600;">@/data/</code></li>
                    <li>Press <kbd style="background: var(--gray-200); padding: 0.2rem 0.5rem; border-radius: 3px; font-family: monospace; font-weight: 600;">Tab</kbd> to see available sessions</li>
                    <li>Select your session (starts with your user ID)</li>
                    <li>Type: <code style="background: white; padding: 0.2rem 0.5rem; border-radius: 3px; color: #059669; font-weight: 600;">/load_results.pml</code></li>
                    <li>Press <kbd style="background: var(--gray-200); padding: 0.2rem 0.5rem; border-radius: 3px; font-family: monospace; font-weight: 600;">Enter</kbd></li>
                </ol>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; font-size: 0.875rem;">
        <strong>üí° PyMOL Navigation Tips:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--gray-700);">
            <li><strong>Rotate:</strong> Left-click and drag</li>
            <li><strong>Zoom:</strong> Scroll wheel or right-click drag up/down</li>
            <li><strong>Pan:</strong> Middle-click drag (or Shift + left-click drag)</li>
            <li><strong>Center view:</strong> Type <code>zoom</code> in console</li>
            <li><strong>Reset view:</strong> Type <code>reset</code> in console</li>
            <li><strong>Hide/show objects:</strong> Use the right panel object list</li>
        </ul>
    </div>
    
    <div style="margin-top: 1rem; padding: 1rem; background: #FEF3C7; border-left: 4px solid #F59E0B; border-radius: 8px; font-size: 0.875rem;">
        <strong>‚ö†Ô∏è Session Information:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--gray-700);">
            <li>Your PyMOL session will expire after the timeout period shown above</li>
            <li>Relaunching PyMOL will create a fresh session (old sessions are automatically cleaned up)</li>
            <li>Closing the viewer will clean up the session to free up space</li>
            <li>All your result files remain safely stored and can be downloaded anytime</li>
        </ul>
    </div>
</div>
{% endif %}

{% if output_files %}
<div class="card" style="background: #e8f4f8; border-left: 4px solid #0066cc;">
    <details>
        <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: 0.5rem 0;">
            üí° Understanding Your Results
        </summary>
        <div style="margin-top: 1rem; padding-left: 1rem;">
            <p style="margin-bottom: 1rem;">Your MaSIF-neosurf job has generated several types of files organized in directories:</p>
            
            <div style="margin: 0.5rem 0;">
                <strong>üìÇ output/</strong> - Main results with 3D surface meshes (.ply) and predictions (.npy)
            </div>
            <div style="margin: 0.5rem 0;">
                <strong>üìÇ data_preparation/</strong> - Preprocessed structures (intermediate files)
            </div>
            <div style="margin: 0.5rem 0;">
                <strong>üìÇ descriptors/</strong> - Surface features and molecular descriptors
            </div>
            <div style="margin: 0.5rem 0;">
                <strong>üìÇ targets/</strong> - Predicted binding site locations
            </div>
            
            <p style="margin-top: 1rem;">
                <strong>Visualization:</strong> Use PyMOL, Chimera, or MeshLab to view .ply files. 
                Use Python with NumPy to analyze .npy arrays.
            </p>
            
            <p style="margin-top: 0.5rem;">
                <a href="{{ url_for('help_page') }}" style="color: #0066cc; text-decoration: underline;">
                    üìñ View detailed documentation and visualization guide
                </a>
            </p>
        </div>
    </details>
</div>
{% endif %}

{% if current_user.is_admin and logs %}
<div class="card">
    <h3>Job Logs (Admin Only)</h3>
    {% for log_name, log_content in logs.items() %}
    <div style="margin-bottom: 1.5rem;">
        <strong>{{ log_name }}:</strong>
        <pre style="max-height: 400px; overflow-y: auto;">{{ log_content }}</pre>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Download Modal -->
<div id="downloadModal" class="download-modal">
    <div class="download-modal-content">
        <div class="download-modal-spinner"></div>
        <h3>Preparing Your Download</h3>
        <p>We're collecting and compressing your files from the HPC cluster.</p>
        <p>This may take a few moments depending on the file size.</p>
        <div class="warning">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Please do not close or refresh this page
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let pymolSessionId = null;
let pymolExpiresAt = null;

// Launch PyMOL viewer
function launchPyMOL() {
    const modal = document.getElementById('downloadModal');
    const modalTitle = modal.querySelector('h3');
    const modalText = modal.querySelector('p');
    const launchBtn = document.getElementById('pymol-launch-btn');
    
    // Show loading modal
    modalTitle.textContent = 'Launching PyMOL...';
    modalText.textContent = 'Preparing your visualization session. This may take a moment as we download files from HPC.';
    modal.classList.add('active');
    launchBtn.disabled = true;
    
    // Prepare session
    fetch('/api/prepare-pymol-session/{{ job_uuid }}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Store session info
                pymolSessionId = data.session_id;
                pymolExpiresAt = Date.now() + (data.expires_in * 1000);
                
                // Update UI with session info
                document.getElementById('pymol-session-id').textContent = data.session_id;
                document.getElementById('pymol-script-path').textContent = data.session_id;
                
                // Update expiry timer
                updateExpiryTimer();
                
                // Load PyMOL in iframe
                const iframe = document.getElementById('pymol-iframe');
                iframe.src = data.pymol_url;
                
                // Show viewer card
                const viewerCard = document.getElementById('pymol-viewer-card');
                viewerCard.style.display = 'block';
                
                // Hide modal
                modal.classList.remove('active');
                
                // Scroll to viewer
                viewerCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Start expiry timer
                setInterval(updateExpiryTimer, 1000);
                
                // Re-enable button
                launchBtn.disabled = false;
                launchBtn.textContent = 'üî¨ Relaunch PyMOL';
            } else {
                alert('Failed to launch PyMOL: ' + data.error);
                modal.classList.remove('active');
                launchBtn.disabled = false;
            }
        })
        .catch(error => {
            alert('Error launching PyMOL: ' + error);
            modal.classList.remove('active');
            launchBtn.disabled = false;
        });
}

// Close PyMOL viewer
function closePyMOL() {
    const viewerCard = document.getElementById('pymol-viewer-card');
    const iframe = document.getElementById('pymol-iframe');
    
    // Clear iframe
    iframe.src = '';
    
    // Hide viewer
    viewerCard.style.display = 'none';
    
    // Cleanup session on server
    if (pymolSessionId) {
        fetch(`/api/cleanup-pymol-session/${pymolSessionId}`, {
            method: 'POST'
        }).catch(err => console.error('Failed to cleanup session:', err));
        
        pymolSessionId = null;
        pymolExpiresAt = null;
    }
}

// Update expiry timer
function updateExpiryTimer() {
    if (!pymolExpiresAt) return;
    
    const now = Date.now();
    const remaining = Math.max(0, pymolExpiresAt - now);
    
    if (remaining === 0) {
        document.getElementById('pymol-expires').textContent = 'Expired';
        document.getElementById('pymol-expires').style.color = 'var(--danger)';
        return;
    }
    
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    
    document.getElementById('pymol-expires').textContent = `${minutes}m ${seconds}s`;
    
    if (minutes < 5) {
        document.getElementById('pymol-expires').style.color = 'var(--warning)';
    }
}

// PyMOL command display - no copy button needed, users will type with Tab autocomplete

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (pymolSessionId) {
        // Use sendBeacon for reliable cleanup
        navigator.sendBeacon(`/api/cleanup-pymol-session/${pymolSessionId}`);
    }
});

// Download all files with modal
function downloadAllFiles() {
    const modal = document.getElementById('downloadModal');
    modal.classList.add('active');
    
    // Create hidden iframe for download
    let iframe = document.getElementById('download-frame');
    if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'download-frame';
        iframe.name = 'download-frame';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
    }
    
    // Trigger download
    iframe.src = "{{ url_for('download_all_files', job_uuid=job_uuid) }}";
    
    // Hide modal after download starts (with fallback)
    let downloadStarted = false;
    const checkDownload = setInterval(() => {
        try {
            if (iframe.contentWindow.document.readyState === 'complete') {
                downloadStarted = true;
            }
        } catch (e) {
            // Cross-origin, download likely started
            downloadStarted = true;
        }
        
        if (downloadStarted) {
            clearInterval(checkDownload);
            setTimeout(() => {
                modal.classList.remove('active');
            }, 2000);
        }
    }, 500);
    
    // Fallback: hide modal after 30 seconds
    setTimeout(() => {
        clearInterval(checkDownload);
        modal.classList.remove('active');
    }, 30000);
}

// Auto-refresh every 10 seconds if job is running
{% if status in ['RUNNING', 'PENDING', 'CONFIGURING'] %}
setTimeout(() => {
    location.reload();
}, 10000);
{% endif %}

{% if output_files %}
// Build file tree structure
const files = {{ output_files | tojson }};
const jobUuid = "{{ job_uuid }}";

function buildFileTree(files) {
    const tree = {};
    
    files.forEach(filePath => {
        const parts = filePath.split('/');
        let current = tree;
        
        parts.forEach((part, index) => {
            if (index === parts.length - 1) {
                // It's a file
                if (!current._files) current._files = [];
                current._files.push({ name: part, path: filePath });
            } else {
                // It's a folder
                if (!current[part]) {
                    current[part] = {};
                }
                current = current[part];
            }
        });
    });
    
    return tree;
}

function renderTree(tree, parentElement, level = 0) {
    const ul = document.createElement('ul');
    ul.className = 'file-tree';
    if (level > 0) {
        ul.className += ' nested';
    }
    
    // Render folders first
    const folders = Object.keys(tree).filter(key => key !== '_files').sort();
    folders.forEach(folderName => {
        const li = document.createElement('li');
        
        const folderDiv = document.createElement('div');
        folderDiv.className = 'folder';
        folderDiv.innerHTML = `<span class="folder-icon">‚ñ∂</span> üìÅ <strong>${folderName}</strong>`;
        
        folderDiv.onclick = function(e) {
            e.stopPropagation();
            const icon = this.querySelector('.folder-icon');
            const nested = this.parentElement.querySelector('.nested');
            icon.classList.toggle('expanded');
            nested.classList.toggle('active');
        };
        
        li.appendChild(folderDiv);
        
        // Recursively render subfolder contents
        const subTree = renderTree(tree[folderName], li, level + 1);
        li.appendChild(subTree);
        
        ul.appendChild(li);
    });
    
    // Render files
    if (tree._files) {
        tree._files.sort((a, b) => a.name.localeCompare(b.name)).forEach(file => {
            const li = document.createElement('li');
            li.className = 'file-item';
            
            const downloadUrl = `/download/${jobUuid}/${encodeURIComponent(file.path)}`;
            li.innerHTML = `üìÑ <a href="${downloadUrl}">${file.name}</a>`;
            
            ul.appendChild(li);
        });
    }
    
    return ul;
}

// Build and render the tree
const tree = buildFileTree(files);
const browser = document.getElementById('file-browser');
const renderedTree = renderTree(tree, browser);
browser.appendChild(renderedTree);

// Expand root level folders by default
document.querySelectorAll('.file-tree > li > .folder').forEach(folder => {
    folder.click();
});
{% endif %}
</script>
{% endblock %}
